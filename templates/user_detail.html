<!DOCTYPE html>
<html lang="{{ get_locale() }}">
<head>
    <meta charset="UTF-8">
    <title>{{ _('User Details') }} - {{ user.name }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <!-- FontAwesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <!-- Chart.js Luxon date adapter para ejes de tiempo -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
    <!-- jQuery UI para el date picker -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <!-- Scripts de localización para el date picker -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/i18n/jquery-ui-i18n.min.js"></script>
    <style>
        .metric-card {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .metric-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .alert-card {
            border-left: 4px solid;
            margin-bottom: 0.5rem;
        }
        .alert-high {
            border-left-color: #dc3545;
        }
        .alert-medium {
            border-left-color: #ffc107;
        }
        .alert-low {
            border-left-color: #198754;
        }
        .chart-container {
            position: relative;
            height: 200px;
            margin-bottom: 1rem;
        }
        .nav-tabs .nav-link {
            color: #495057;
        }
        .nav-tabs .nav-link.active {
            color: #0d6efd;
            font-weight: bold;
        }
        .user-info {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .loading {
            text-align: center;
            padding: 2rem;
        }
        .loading i {
            font-size: 2rem;
            color: #0d6efd;
        }
    </style>
</head>
<body class="bg-light">
<!-- Navbar estilo base.html -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container">
    <a class="navbar-brand" href="/livelyageing/home">
      <i class="fas fa-heartbeat me-2"></i>Lively Ageing
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item">
          <a class="nav-link" href="/livelyageing/home">
            <i class="fas fa-home me-1"></i>{{ _('Welcome') }}
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/livelyageing/dashboard/alerts">
            <i class="fas fa-chart-line me-1"></i>{{ _('Alert Dashboard') }}
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/livelyageing/link">
            <i class="fas fa-plus-circle me-1"></i>{{ _('Link Device') }}
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/livelyageing/logout">
            <i class="fas fa-sign-out-alt me-1"></i>{{ _('Logout') }}
          </a>
        </li>
      </ul>
      <ul class="navbar-nav">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="languageDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-globe"></i> {{ _('Language') }}
          </a>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="languageDropdown">
  <li><a class="dropdown-item {% if get_locale() == 'es' %}active{% endif %}" href="{{ url_for('change_language', lang='es') }}">{{ _('Spanish') }}</a></li>
  <li><a class="dropdown-item {% if get_locale() == 'en' %}active{% endif %}" href="{{ url_for('change_language', lang='en') }}">{{ _('English') }}</a></li>
</ul>
        </li>
      </ul>
    </div>
  </div>
</nav>
<!-- Botón de volver -->
<a href="javascript:history.back()" class="btn btn-outline-secondary mb-3" style="position:relative;z-index:2;">
  <i class="bi bi-arrow-left"></i> {{ _('Back') }}
</a>
<div class="container my-5">
    <!-- Información del Usuario -->
    <div class="user-info">
        <div class="row">
            <div class="col-md-8">
                <h2>{{ user.name }}</h2>
                <p class="text-muted mb-0">
                    <i class="bi bi-envelope"></i> {{ user.email }}<br>
                    <i class="bi bi-calendar"></i> {{ _('Registered on') }} {{ user.created_at.strftime('%d/%m/%Y') }}
                    {% if user.age %}
                    <br><i class="bi bi-person"></i> {{ user.age }} {{ _('years old') }}
                    {% endif %}
                </p>
                {% if last_update_datetime %}
                    {% set diff_seconds = (now - last_update_datetime).total_seconds() %}
                    <p class="mt-2">
                        <i class="bi bi-clock-history"></i>
                        {{ _('Last update') }}:
                        {% if diff_seconds < 60 %}
                            {{ _('less than a minute ago') }}
                        {% elif diff_seconds < 3600 %}
                            {{ (diff_seconds // 60)|int }} {{ _('minutes ago') }}
                        {% elif diff_seconds < 86400 %}
                            {{ (diff_seconds // 3600)|int }} {{ _('hours ago') }}
                        {% else %}
                            {{ (diff_seconds // 86400)|int }} {{ _('days ago') }}
                        {% endif %}
                    </p>
                {% endif %}
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-outline-primary" onclick="refreshData()">
                    <i class="bi bi-arrow-clockwise"></i> {{ _('Refresh Data') }}
                </button>
            </div>
        </div>
    </div>

    <!-- Resumen Diario -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value {% if latest_summary and latest_summary.steps and alerts.activity_drop %}text-danger{% endif %}" id="steps-value">
                    {% if latest_summary and latest_summary.steps %}
                    {{ "{:,}".format(latest_summary.steps) }}
                    {% if alerts.activity_drop %}
                    <i class="fas fa-exclamation-triangle text-danger" title="{{ _('Physical activity below average') }}"></i>
                    {% endif %}
                    {% else %}
                    -
                    {% endif %}
                </div>
                <div class="metric-label">{{ _('Steps') }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value {% if latest_summary and latest_summary.heart_rate and alerts.heart_rate_anomaly %}text-danger{% endif %}" id="heart-rate-value">
                    {% if latest_summary and latest_summary.heart_rate %}
                    {{ latest_summary.heart_rate }}
                    {% if alerts.heart_rate_anomaly %}
                    <i class="fas fa-exclamation-circle text-danger" title="{{ _('Abnormal Heart Rate') }}"></i>
                    {% endif %}
                    {% else %}
                    -
                    {% endif %}
                </div>
                <div class="metric-label">{{ _('Heart Rate (bpm)') }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value {% if latest_summary and latest_summary.sleep_minutes and alerts.sleep_duration_change %}text-warning{% endif %}" id="sleep-value">
                    {% if latest_summary and latest_summary.sleep_minutes %}
                    {{ (latest_summary.sleep_minutes / 60)|round(1) }}
                    {% if alerts.sleep_duration_change %}
                    <i class="fas fa-bed text-warning" title="{{ _('Significant change in sleep pattern') }}"></i>
                    {% endif %}
                    {% else %}
                    -
                    {% endif %}
                </div>
                <div class="metric-label">{{ _('Sleep Hours') }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value" id="calories-value">
                    {% if latest_summary and latest_summary.calories %}
                    {{ "{:,}".format(latest_summary.calories) }}
                    {% else %}
                    -
                    {% endif %}
                </div>
                <div class="metric-label">{{ _('Calories') }}</div>
            </div>
        </div>
    </div>

    <!-- Pestañas de Navegación -->
    <ul class="nav nav-tabs mb-4" id="userTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="daily-tab" data-bs-toggle="tab" href="#daily" role="tab">
                {{ _('Daily Summary') }}
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="intraday-tab" data-bs-toggle="tab" href="#intraday" role="tab">
                {{ _('Intraday Data') }}
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="weekly-tab" data-bs-toggle="tab" href="#weekly" role="tab">
                {{ _('Weekly Summary') }}
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="alerts-tab" data-bs-toggle="tab" href="#alerts" role="tab">
                {{ _('Recent Alerts') }}
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="inactivity-tab" data-bs-toggle="tab" href="#inactivity" role="tab">
                {{ _('Inactivity Patterns') }}
            </a>
        </li>
    </ul>

    <!-- Contenido de las Pestañas -->
    <div class="tab-content" id="userTabsContent">
        <!-- Resumen Diario -->
        <div class="tab-pane fade show active" id="daily" role="tabpanel">
            <div class="row">
                <div class="col-md-6">
                    <div class="metric-card">
                        <h5>{{ _('Physical Activity') }}</h5>
                        <div class="row">
                            <div class="col-6">
                                <div class="metric-value" id="distance-value">
                                    {% if latest_summary and latest_summary.distance %}
                                    {{ latest_summary.distance|round(1) }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </div>
                                <div class="metric-label">{{ _('Distance (km)') }}</div>
                            </div>
                            <div class="col-6">
                                <div class="metric-value" id="floors-value">
                                    {% if latest_summary and latest_summary.floors %}
                                    {{ latest_summary.floors }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </div>
                                <div class="metric-label">{{ _('Floors') }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="metric-card">
                        <h5>{{ _('Activity vs Sedentary') }}</h5>
                        <div class="row">
                            <div class="col-6">
                                <div class="metric-value" id="active-minutes-value">
                                    {% if latest_summary and latest_summary.active_minutes %}
                                    {{ latest_summary.active_minutes }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </div>
                                <div class="metric-label">{{ _('Active Minutes') }}</div>
                            </div>
                            <div class="col-6">
                                <div class="metric-value" id="sedentary-hours-value">
                                    {% if latest_summary and latest_summary.sedentary_minutes %}
                                    {{ (latest_summary.sedentary_minutes / 60)|round(1) }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </div>
                                <div class="metric-label">{{ _('Sedentary Hours') }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="metric-card">
                        <h5>{{ _('Nutrition') }}</h5>
                        <div class="row">
                            <div class="col-6">
                                <div class="metric-value" id="nutrition-calories-value">
                                    {% if latest_summary and latest_summary.nutrition_calories %}
                                    {{ "{:,}".format(latest_summary.nutrition_calories) }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </div>
                                <div class="metric-label">{{ _('Calories Consumed') }}</div>
                            </div>
                            <div class="col-6">
                                <div class="metric-value" id="water-value">
                                    {% if latest_summary and latest_summary.water %}
                                    {{ latest_summary.water|round(1) }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </div>
                                <div class="metric-label">{{ _('Water (L)') }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="metric-card">
                        <h5>{{ _('Body Composition') }}</h5>
                        <div class="row">
                            <div class="col-4">
                                <div class="metric-value" id="weight-value">
                                    {% if latest_summary and latest_summary.weight %}
                                    {{ latest_summary.weight|round(1) }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </div>
                                <div class="metric-label">{{ _('Weight (kg)') }}</div>
                            </div>
                            <div class="col-4">
                                <div class="metric-value" id="bmi-value">
                                    {% if latest_summary and latest_summary.bmi %}
                                    {{ latest_summary.bmi|round(1) }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </div>
                                <div class="metric-label">{{ _('BMI') }}</div>
                            </div>
                            <div class="col-4">
                                <div class="metric-value" id="fat-value">
                                    {% if latest_summary and latest_summary.fat %}
                                    {{ latest_summary.fat|round(1) }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </div>
                                <div class="metric-label">{{ _('Fat') }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Datos Intradía -->
        <div class="tab-pane fade" id="intraday" role="tabpanel">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">{{ _('Intraday Data') }}</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="intradayDate" class="form-label">{{ _('Date') }}:</label>
                            <input type="text" class="form-control" id="intradayDate" value="{{ now.strftime('%d/%m/%Y') if get_locale() == 'es' else now.strftime('%m/%d/%Y') }}">
                        </div>
                        <div class="col-md-4">
                            <label for="intradayMetric" class="form-label">{{ _('Metric') }}:</label>
                            <select class="form-select" id="intradayMetric">
                                <option value="steps">{{ _('Steps') }}</option>
                                <option value="heart_rate">{{ _('Heart Rate') }}</option>
                                <option value="calories">{{ _('Calories') }}</option>
                                <option value="active_zone_minutes">{{ _('Active Minutes') }}</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="chartType" class="form-label">{{ _('Chart Type') }}:</label>
                            <select class="form-select" id="chartType">
                                <option value="line">{{ _('Line') }}</option>
                                <option value="bar">{{ _('Bar') }}</option>
                                <option value="area">{{ _('Area') }}</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="chart-container" style="position: relative; height:400px;">
                                <canvas id="intradayChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button class="btn btn-outline-primary" onclick="exportIntradayData()">
                                <i class="fas fa-file-csv"></i> {{ _('Export to CSV') }}
                            </button>
                        </div>
                    </div>
                    <div id="modal-intraday-warning" class="alert alert-warning mt-2 d-none">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        {{ _('Not enough intraday data to show activity pattern (<6 points).') }}
                        <br>
                        <small>
                            {{ _('This may be due to insufficient data recorded by the device or the device not being worn during the day.') }}
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resumen Semanal -->
        <div class="tab-pane fade" id="weekly" role="tabpanel">
            <div class="row">
                <div class="col-md-6">
                    <div class="chart-container">
                        <canvas id="weekly-steps-chart"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-container">
                        <canvas id="weekly-heart-rate-chart"></canvas>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="chart-container">
                        <canvas id="weekly-sleep-chart"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-container">
                        <canvas id="weekly-activity-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alertas Recientes -->
        <div class="tab-pane fade" id="alerts" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">{{ _('Recent Alerts') }}</h5>
                {% if recent_alerts and recent_alerts|length > 0 %}
                <a href="{{ url_for('export_user_alerts', user_id=user.id) }}" class="btn btn-outline-success btn-sm" title="{{ _('Export alerts to CSV') }}">
                    <i class="fas fa-file-csv"></i> {{ _('Export to CSV') }}
                </a>
                {% endif %}
            </div>
            <div id="alerts-container">
                {% if recent_alerts and recent_alerts|length > 0 %}
                    {% for alert in recent_alerts %}
                    <div class="alert alert-card alert-{{ alert.priority|lower }}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">
                                {% if alert.alert_type == 'intraday_activity_drop' %}
                                    <i class="fas fa-hourglass-end text-danger me-2" title="{{ _('Prolonged period without activity') }}"></i>
                                {% endif %}
                                {{ alert.alert_type }}
                                </h5>
                                <p class="mb-0">
                                    <small>{{ alert.alert_time.strftime('%d/%m/%Y %H:%M') }}</small>
                                </p>
                            </div>
                            <div>
                                {% if not alert.acknowledged %}
                                <button class="btn btn-sm btn-outline-success acknowledge-btn" type="button" data-alert-id="{{ alert.id }}">
                                    <i class="bi bi-check-circle"></i> {{ _('Acknowledge') }}
                                </button>
                                {% else %}
                                <span class="badge bg-success">{{ _('Acknowledged') }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <p class="mb-0 mt-2">
                        {% if alert.alert_type == 'intraday_activity_drop' %}
                            <div class="bg-light p-2 border-start border-danger border-3 rounded">
                                {% if '|' in alert.details %}
                                    {% set key = alert.details.split('|')[0] %}
                                    {% set params = alert.details.split('|')[1:] %}
                                    {% set translated = _(key) %}
                                    {% for param in params %}
                                        {% set name = param.split('=')[0] %}
                                        {% set value = param.split('=')[1] %}
                                        {% set translated = translated.replace('{' + name + '}', value) %}
                                    {% endfor %}
                                    {{ translated }}
                                {% else %}
                                    {{ alert.details }}
                                {% endif %}
                                <br>
                                <small class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ _('Prolonged periods without activity are associated with increased cardiovascular risk and functional decline.') }}</small>
                            </div>
                        {% else %}
                            <div class="bg-light p-2 border-start border-3 rounded">
                                {% if '|' in alert.details %}
                                    {% set key = alert.details.split('|')[0] %}
                                    {% set params = alert.details.split('|')[1:] %}
                                    {% set translated = _(key) %}
                                    {% for param in params %}
                                        {% set name = param.split('=')[0] %}
                                        {% set value = param.split('=')[1] %}
                                        {% set translated = translated.replace('{' + name + '}', value) %}
                                    {% endfor %}
                                    {{ translated }}
                                {% else %}
                                    {{ alert.details }}
                                {% endif %}
                            </div>
                        {% endif %}
                        </p>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info text-center mt-3">{{ _('No recent alerts for this user.') }}</div>
                {% endif %}
            </div>
        </div>

        <!-- Patrones de Inactividad -->
        <div class="tab-pane fade" id="inactivity" role="tabpanel">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{{ _('Inactivity Pattern Analysis') }}</h5>
                    <div>
                        <label for="inactivityDay" class="form-label">{{ _('Date') }}:</label>
                        <input type="text" class="form-control" id="inactivityDay" value="{{ now.strftime('%d/%m/%Y') if get_locale() == 'es' else now.strftime('%m/%d/%Y') }}">
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> {{ _('Clinical Relevance') }}</h6>
                        <p>{{ _('Prolonged periods of inactivity (≥2 hours) may indicate:') }}</p>
                        <ul>
                            <li>{{ _('Excessive sedentary behavior') }}</li>
                            <li>{{ _('Possible mobility issues') }}</li>
                            <li>{{ _('Undetected falls or emergency situations') }}</li>
                            <li>{{ _('Changes in daily routines that require attention') }}</li>
                        </ul>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="chart-container" style="position: relative; height:300px;">
                                <canvas id="inactivityChart"></canvas>
                            </div>
                            <div id="inactivityLegend" class="mt-3 text-center">
                                <span class="badge rounded-pill bg-danger me-2">■</span> {{ _('Periods without activity') }}
                                <span class="badge rounded-pill bg-warning me-2">■</span> {{ _('Low activity (≤100 steps/hour)') }}
                                <span class="badge rounded-pill bg-success me-2">■</span> {{ _('Normal activity') }}
                            </div>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-12">
                            <h6>{{ _('Detected inactivity periods:') }}</h6>
                            <div id="inactivityPeriods" class="mt-2">
                                <div class="d-flex justify-content-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">{{ _('Loading...') }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script>
// --- SOLUCIÓN ReferenceError: _ is not defined ---
// Función dummy para traducción en JS (solo devuelve el texto tal cual)
function _(txt) { return txt; }

// Register Chart.js annotation plugin robustly
if (window['ChartAnnotation']) {
    Chart.register(window['ChartAnnotation']);
} else if (window['chartjsPluginAnnotation']) {
    Chart.register(window['chartjsPluginAnnotation']);
} else if (window['chartjs-plugin-annotation']) {
    Chart.register(window['chartjs-plugin-annotation']);
} else {
    console.warn('Chart.js annotation plugin not found!');
}

// Registrar plugin de DataLabels
if (window.ChartDataLabels) {
    Chart.register(window.ChartDataLabels);
} else {
    console.warn('Chart.js DataLabels plugin not found or not loaded correctly!');
}

let weeklyCharts = {};
let inactivityChart = null;
let currentAlerts = [];

// Guardar y restaurar la pestaña activa al recargar
function setActiveTab(tabId) {
    localStorage.setItem('userDetailActiveTab', tabId);
}
function restoreActiveTab() {
    const tabId = localStorage.getItem('userDetailActiveTab');
    if (tabId) {
        const tab = document.querySelector(`a[href='${tabId}']`);
        if (tab) {
            new bootstrap.Tab(tab).show();
        }
    }
}
document.addEventListener('DOMContentLoaded', function() {
    // Configurar el idioma del date picker
    const currentLang = '{{ get_locale() }}';
    if($.datepicker) {
        // Configurar el formato de fecha según el idioma
        const dateFormat = currentLang === 'es' ? 'dd/mm/yy' : 'mm/dd/yy';
        
        // Inicializar los date pickers con el idioma correspondiente
        $("#intradayDate, #inactivityDay").datepicker({
            dateFormat: dateFormat,
            changeMonth: true,
            changeYear: true,
            maxDate: '0',
            regional: currentLang,
            onSelect: function(dateText, inst) {
                if (this.id === 'intradayDate') {
                    loadIntradayData();
                } else if (this.id === 'inactivityDay') {
                    loadInactivityData();
                }
            }
        });

        // Establecer el idioma
        if(currentLang === 'es') {
            $("#intradayDate, #inactivityDay").datepicker('option', $.datepicker.regional['es']);
        } else {
            $("#intradayDate, #inactivityDay").datepicker('option', $.datepicker.regional['']);
        }
    }
    
    // Eliminar readonly de los inputs de fecha para permitir interacción completa
    $(document).ready(function() {
        $('#intradayDate').removeAttr('readonly');
        $('#inactivityDay').removeAttr('readonly');
    });
    
    // Restaurar pestaña activa si existe
    restoreActiveTab();
    // Guardar pestaña activa al cambiar
    document.querySelectorAll('#userTabs a[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(e) {
            setActiveTab(e.target.getAttribute('href'));
        });
    });
    
    // Cargar datos iniciales
    loadIntradayData();
    loadWeeklyData();
    loadInactivityData();
    
    // Configurar event listeners
    document.getElementById('intradayMetric').addEventListener('change', loadIntradayData);
    document.getElementById('intradayDate').addEventListener('change', loadIntradayData);
    document.getElementById('chartType').addEventListener('change', loadIntradayData);
    document.getElementById('inactivityDay').addEventListener('change', loadInactivityData);
});

// Función para convertir fecha del datepicker al formato ISO
function convertDateToISO(dateStr) {
    if (!dateStr) return '';
    const currentLang = '{{ get_locale() }}';
    let parts;
    if (currentLang === 'es') {
        // Formato español: dd/mm/yyyy
        parts = dateStr.split('/');
        return `${parts[2]}-${parts[1]}-${parts[0]}`;
    } else {
        // Formato inglés: mm/dd/yyyy
        parts = dateStr.split('/');
        return `${parts[2]}-${parts[0]}-${parts[1]}`;
    }
}

// Función para cargar datos intradía
function loadIntradayData() {
    const dateStr = document.getElementById('intradayDate').value;
    const date = convertDateToISO(dateStr);
    const metric = document.getElementById('intradayMetric').value;
    const chartType = document.getElementById('chartType').value;
    const chartContainer = document.querySelector('.chart-container');
    const warningDivId = 'modal-intraday-warning';
    let warningDiv = document.getElementById(warningDivId);
    if (!warningDiv) {
        warningDiv = document.createElement('div');
        warningDiv.id = warningDivId;
        chartContainer.parentNode.insertBefore(warningDiv, chartContainer.nextSibling);
    }
    warningDiv.innerHTML = '';
    fetch(`/livelyageing/api/user/{{ user.id }}/intraday?date=${date}&type=${metric}`)
        .then(response => response.json())
        .then(data => {
            // Si hay menos de 6 puntos, mostrar advertencia y ocultar gráfica
            if (!data.intraday || data.intraday.length < 6) {
                chartContainer.classList.add('d-none');
                warningDiv.innerHTML = `
                    <div class="alert alert-warning mt-2">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        {{ _('Not enough intraday data to show activity pattern (<6 points).') }}<br>
                        <small>{{ _('This may be due to insufficient data recorded by the device or the device not being worn during the day.') }}</small>
                    </div>`;
                if (window.intradayChart) {
                    window.intradayChart.destroy();
                }
                return;
            } else {
                chartContainer.classList.remove('d-none');
                warningDiv.innerHTML = '';
            }
            fetch(`/livelyageing/api/user/{{ user.id }}/alerts?date=${date}`)
                .then(response => response.json())
                .then(alerts => {
                    currentAlerts = alerts.alerts.filter(a => a.type.includes(metric.split('_')[0]));
                    updateIntradayChart(data.intraday, chartType);
                });
        })
        .catch(error => {
            console.error('Error:', error);
            warningDiv.innerHTML = `<div class='alert alert-danger'>${error.message}</div>`;
        });
}

function updateIntradayChart(data, chartType) {
    const ctx = document.getElementById('intradayChart').getContext('2d');
    if (window.intradayChart && typeof window.intradayChart.destroy === 'function') {
        window.intradayChart.destroy();
    }
    const metric = document.getElementById('intradayMetric').value;
    let borderColor, backgroundColorBar, backgroundColorArea;
    switch(metric) {
        case 'heart_rate':
            borderColor = 'rgb(220, 53, 69)';
            backgroundColorBar = 'rgba(220, 53, 69, 0.7)';
            backgroundColorArea = 'rgba(220, 53, 69, 0.2)';
            break;
        case 'steps':
            borderColor = 'rgb(40, 167, 69)';
            backgroundColorBar = 'rgba(40, 167, 69, 0.7)';
            backgroundColorArea = 'rgba(40, 167, 69, 0.2)';
            break;
        case 'calories':
            borderColor = 'rgb(255, 123, 0)';
            backgroundColorBar = 'rgba(255, 123, 0, 0.7)';
            backgroundColorArea = 'rgba(255, 123, 0, 0.2)';
            break;
        case 'active_zone_minutes':
            borderColor = 'rgb(102, 16, 242)';
            backgroundColorBar = 'rgba(102, 16, 242, 0.7)';
            backgroundColorArea = 'rgba(102, 16, 242, 0.2)';
            break;
        default:
            borderColor = 'rgb(23, 162, 184)';
            backgroundColorBar = 'rgba(23, 162, 184, 0.7)';
            backgroundColorArea = 'rgba(23, 162, 184, 0.2)';
    }
    let finalBackgroundColor;
    if (chartType === 'bar') {
        finalBackgroundColor = backgroundColorBar;
    } else if (chartType === 'area') {
        finalBackgroundColor = backgroundColorArea;
    } else {
        finalBackgroundColor = 'rgba(0,0,0,0)';
    }
    // Forzar formato ISO para los timestamps
    const formatToISO = t => {
        if (!t) return t;
        if (typeof t === 'string') {
            // Si ya es ISO y tiene microsegundos, quitarlos
            if (t.includes('T')) return t.split('.')[0];
            // Si es tipo 'YYYY-MM-DD HH:mm:ss', convertir a ISO
            if (t.includes(' ')) return t.replace(' ', 'T');
        }
        if (t instanceof Date) return t.toISOString().split('.')[0];
        return t;
    };
    // Obtener el día seleccionado en formato YYYY-MM-DD
    const dateStr = document.getElementById('intradayDate').value;
    const currentLang = '{{ get_locale() }}';
    let selectedDay;
    if (currentLang === 'es') {
        // dd/mm/yyyy
        const parts = dateStr.split('/');
        selectedDay = `${parts[2]}-${parts[1]}-${parts[0]}`;
    } else {
        // mm/dd/yyyy
        const parts = dateStr.split('/');
        selectedDay = `${parts[2]}-${parts[0]}-${parts[1]}`;
    }
    // Extraer solo día y mes del selectedDay
    const [selYear, selMonth, selDay] = selectedDay.split('-');
    // Normalizar todos los labels y guardar día y hora
    const labels = data.map(d => {
        if (typeof d.time === 'string' && d.time.includes('T')) {
            return d.time.split('T')[1].substring(0,5); // 'HH:mm'
        }
        if (typeof d.time === 'string' && d.time.includes(' ')) {
            return d.time.split(' ')[1].substring(0,5);
        }
        return d.time;
    });
    const days = data.map(d => {
        if (typeof d.time === 'string' && d.time.includes('T')) {
            return d.time.split('T')[0];
        }
        if (typeof d.time === 'string' && d.time.includes(' ')) {
            return d.time.split(' ')[0];
        }
        return '';
    });
    // LOGS para depuración
    console.log('selectedDay:', selectedDay);
    console.log('labels:', labels);
    console.log('days:', days);
    console.log('currentAlerts:', currentAlerts);
    const chartData = {
        labels: labels,
        datasets: [{
            label: document.getElementById('intradayMetric').options[document.getElementById('intradayMetric').selectedIndex].text,
            data: data.map(d => d.value),
            borderColor: borderColor,
            backgroundColor: finalBackgroundColor,
            borderWidth: chartType === 'line' ? 2 : 1,
            tension: 0.1,
            fill: chartType === 'area'
        }]
    };
    // Solo mostrar el punto rojo si la alerta es del mismo día y mes (ignorar año) y hora/minuto
    const alertAnnotations = [];
    currentAlerts.forEach(alert => {
        let alertTime = alert.alert_time;
        let alertDay = '', alertHour = '';
        if (typeof alertTime === 'string' && alertTime.includes('T')) {
            [alertDay, alertHour] = alertTime.split('T');
            alertHour = alertHour.substring(0,5);
        } else if (typeof alertTime === 'string' && alertTime.includes(' ')) {
            // Puede ser 'YYYY-MM-DD HH:mm' o 'DD/MM HH:mm'
            const [datePart, hourPart] = alertTime.split(' ');
            if (datePart.match(/^\d{4}-\d{2}-\d{2}$/)) {
                alertDay = datePart;
            } else if (datePart.match(/^\d{2}\/\d{2}$/)) {
                // 'DD/MM' => usar año del selectedDay
                const [d, m] = datePart.split('/');
                alertDay = `${selYear}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
            } else if (datePart.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                // 'DD/MM/YYYY'
                const [d, m, y] = datePart.split('/');
                alertDay = `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
            }
            alertHour = hourPart.substring(0,5);
        }
        // Extraer solo mes y día de alertDay
        let alertMonth = '', alertDayNum = '';
        if (alertDay && alertDay.includes('-')) {
            const parts = alertDay.split('-');
            alertMonth = parts[1];
            alertDayNum = parts[2];
        }
        // Comparar solo mes y día
        if (alertMonth === selMonth && alertDayNum === selDay) {
            for (let i = 0; i < labels.length; i++) {
                if (labels[i].substring(0,5) === alertHour.substring(0,5)) {
                    alertAnnotations.push({
                        type: 'point',
                        xValue: labels[i],
                        yValue: data[i].value,
                        backgroundColor: 'red',
                        borderColor: 'red',
                        radius: 8,
                        label: {
                            content: alert.type,
                            enabled: true
                        }
                    });
                }
            }
        }
    });
    console.log('alertAnnotations:', alertAnnotations);
    const options = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: {
                type: 'category',
            },
            y: {
                beginAtZero: true
            }
        },
        plugins: {
            annotation: {
                annotations: alertAnnotations
            }
        }
    };
    window.intradayChart = new Chart(ctx, {
        type: chartType === 'area' ? 'line' : chartType,
        data: chartData,
        options: options
    });
}

// Función para cargar datos semanales
function loadWeeklyData() {
    fetch(`/livelyageing/api/user/{{ user.id }}/weekly_summary`)
        .then(response => response.json())
        .then((data) => {
            // Gráfico de pasos
            createWeeklyChart('weekly-steps-chart', '{{ _("Steps") }}', data.weekly.map(d => d.steps));
            
            // Gráfico de frecuencia cardíaca
            createWeeklyChart('weekly-heart-rate-chart', '{{ _("Heart Rate") }}', data.weekly.map(d => d.heart_rate));
            
            // Gráfico de sueño
            createWeeklyChart('weekly-sleep-chart', '{{ _("Sleep Hours") }}', data.weekly.map(d => d.sleep_hours));
            
            // Gráfico de actividad
            createWeeklyChart('weekly-activity-chart', '{{ _("Active Minutes") }}', data.weekly.map(d => d.active_minutes));
        })
        .catch(error => console.error('Error:', error));
}

// Función para crear gráficos semanales
function createWeeklyChart(canvasId, label, data) {
    if (weeklyCharts[canvasId]) {
        weeklyCharts[canvasId].destroy();
    }
    
    // Usar colores consistentes con los gráficos intraday
    let chartColor;
    if (canvasId.includes('heart-rate')) {
        chartColor = 'rgba(220, 53, 69, 0.7)'; // Rojo para frecuencia cardíaca
    } else if (canvasId.includes('steps')) {
        chartColor = 'rgba(40, 167, 69, 0.7)'; // Verde para pasos
    } else if (canvasId.includes('sleep')) {
        chartColor = 'rgba(23, 162, 184, 0.7)'; // Azul para sueño
    } else if (canvasId.includes('activity')) {
        chartColor = 'rgba(102, 16, 242, 0.7)'; // Morado para actividad
    } else {
        chartColor = 'rgba(75, 192, 192, 0.7)'; // Color por defecto
    }
    
    const ctx = document.getElementById(canvasId).getContext('2d');
    weeklyCharts[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ["{{ _('Mon') }}", "{{ _('Tue') }}", "{{ _('Wed') }}", "{{ _('Thu') }}", "{{ _('Fri') }}", "{{ _('Sat') }}", "{{ _('Sun') }}"],
            datasets: [{
                label: label,
                data: data,
                backgroundColor: chartColor,
                borderColor: chartColor.replace('0.7', '1'),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Función para reconocer una alerta
function acknowledgeAlert(alertId) {
    fetch(`/livelyageing/api/alerts/${alertId}/acknowledge`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ note: 'Reconocido desde la ficha de usuario' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Recargar manteniendo la pestaña
            location.reload();
        } else {
            alert('Error al reconocer la alerta: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al reconocer la alerta');
    });
}

// Función para actualizar datos
function refreshData() {
    fetch('/livelyageing/refresh_data', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error al actualizar los datos: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al actualizar los datos');
    });
}

function exportIntradayData() {
    const date = document.getElementById('intradayDate').value;
    const metric = document.getElementById('intradayMetric').value;
    window.location.href = `/livelyageing/user/{{ user.id }}/export_intraday?dates=${date}&metrics=${metric}`;
}

// Función para cargar datos de inactividad
function loadInactivityData() {
    console.log("Cargando datos de inactividad...");
    const dateStr = document.getElementById('inactivityDay').value;
    const day = convertDateToISO(dateStr);
    console.log("Fecha seleccionada:", day);
    const periodsContainer = document.getElementById('inactivityPeriods');
    periodsContainer.innerHTML = '<div class="d-flex justify-content-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div></div>';
    
    fetch(`/livelyageing/api/user/{{ user.id }}/intraday?date=${day}&type=steps`)
        .then(response => {
            console.log("Respuesta del servidor recibida:", response.status);
            return response.json();
        })
        .then(result => {
            console.log("Datos recibidos:", result);
            const data = result.intraday || [];
            console.log("Longitud de datos:", data.length);
            
            if (data.length === 0) {
                console.warn("No hay datos para la fecha seleccionada");
                periodsContainer.innerHTML = '<div class="alert alert-warning">{{ _("No data available for the selected date.") }}</div>';
                // Destruir el gráfico existente si existe y es una instancia válida de Chart
                if (window.inactivityChart instanceof Chart) {
                    console.log("Destruyendo gráfico anterior...");
                    window.inactivityChart.destroy();
                    window.inactivityChart = null;
                }
                return;
            }
            
            try {
                // Detectar períodos de inactividad prolongada
                let currentInactivePeriod = null;
                let inactivePeriods = [];
                let inactiveIndices = [];
                data.forEach((point, i) => {
                    const time = point.time;
                    const value = point.value;
                    if (value === 0) {
                        inactiveIndices.push(i);
                        if (!currentInactivePeriod) {
                            currentInactivePeriod = { start: time, end: time, points: 1, indices: [i] };
                        } else {
                            currentInactivePeriod.end = time;
                            currentInactivePeriod.points++;
                            currentInactivePeriod.indices.push(i);
                        }
                    } else {
                        if (currentInactivePeriod && currentInactivePeriod.points >= 2) {
                            inactivePeriods.push({ ...currentInactivePeriod });
                        }
                        currentInactivePeriod = null;
                    }
                });
                if (currentInactivePeriod && currentInactivePeriod.points >= 2) {
                    inactivePeriods.push({ ...currentInactivePeriod });
                }
                
                console.log("Períodos de inactividad detectados:", inactivePeriods.length);
                displayInactivityPeriods(inactivePeriods);
                
                // Colorear barras y resaltar inactividad prolongada
                console.log("Generando colores para barras...");
                const colors = data.map((point, i) => {
                    if (point.value === 0) return 'rgba(220, 53, 69, 0.95)'; // Rojo
                    if (point.value <= 100) return 'rgba(255, 193, 7, 0.95)'; // Amarillo
                    return 'rgba(40, 167, 69, 0.95)'; // Verde
                });
                
                // Borde negro para barras de inactividad prolongada
                let borderColors = data.map((point, i) => {
                    let isProlonged = inactivePeriods.some(period => period.indices.includes(i) && period.points >= 2);
                    return isProlonged ? '#000' : colors[i];
                });
                
                // Crear gráfico
                console.log("Creando gráfico...");
                const ctx = document.getElementById('inactivityChart').getContext('2d');
                
                // Destruir el gráfico existente si existe y es una instancia válida de Chart
                if (window.inactivityChart instanceof Chart) {
                    console.log("Destruyendo gráfico anterior...");
                    window.inactivityChart.destroy();
                    window.inactivityChart = null;
                }
                
                window.inactivityChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(point => point.time),
                        datasets: [{
                            label: "{{ _('Steps') }}",
                            data: data.map(point => point.value),
                            backgroundColor: colors,
                            borderColor: borderColors,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const steps = context.parsed.y;
                                        const time = context.label;
                                        if (steps === 0) return `${_('No activity at')} ${time}`;
                                        if (steps <= 100) return `${_('Low activity')} (${steps} ${_('steps')}) ${_('at')} ${time}`;
                                        return `${steps} ${_('steps at')} ${time}`;
                                    }
                                }
                            },
                            datalabels: {
                                display: function(context) {
                                    const value = context.dataset.data[context.dataIndex];
                                    // Solo mostrar valor si es inactividad o baja actividad
                                    return value === 0 || value <= 100;
                                },
                                color: function(context) {
                                    const value = context.dataset.data[context.dataIndex];
                                    if (value === 0) return '#dc3545'; // Rojo
                                    if (value <= 100) return '#ffc107'; // Amarillo
                                    return 'rgba(0,0,0,0)';
                                },
                                anchor: 'end',
                                align: 'top',
                                font: { weight: 'bold', size: 12 },
                                formatter: function(value) { 
                                    return value > 0 ? value : '0'; 
                                }
                            }
                        },
                        scales: {
                            x: { title: { display: true, text: _('Time of day') } },
                            y: { beginAtZero: true, title: { display: true, text: _('Steps per interval') } }
                        }
                    },
                    plugins: typeof ChartDataLabels !== 'undefined' ? [ChartDataLabels] : []
                });
                console.log("Gráfico creado exitosamente");
            } catch (error) {
                console.error("Error al procesar datos:", error);
                periodsContainer.innerHTML = `<div class="alert alert-danger">${_('Error processing data')}: ${error.message}</div>`;
            }
        })
        .catch(error => {
            console.error("Error en fetch:", error);
            periodsContainer.innerHTML = `<div class="alert alert-danger">${_('Error loading inactivity data')}: ${error.message}</div>`;
        });
}

// Función para mostrar los períodos de inactividad detectados
function displayInactivityPeriods(periods) {
    const container = document.getElementById('inactivityPeriods');
    if (periods.length === 0) {
        container.innerHTML = `<div class="alert alert-success">${_('No significant periods of inactivity detected.')}</div>`;
        return;
    }
    // Ordenar períodos por duración (puntos) descendente
    periods.sort((a, b) => b.points - a.points);
    let html = '<div class="list-group">';
    periods.forEach(period => {
        const durationText = period.points === 1 ? _('1 interval') : `${period.points} ${_('intervals')}`;
        const severityClass = period.points >= 4 ? 'list-group-item-danger' : 
                              period.points >= 3 ? 'list-group-item-warning' : 
                              'list-group-item-info';
        html += `
            <div class="list-group-item ${severityClass} d-flex justify-content-between align-items-center">
                <div>
                    <p class="mb-1">${_('No activity from')} <strong>${period.start}</strong> ${_('to')} <strong>${period.end}</strong> (${durationText})</p>
                </div>
                <span class="badge bg-secondary rounded-pill">${period.points}h</span>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

// Añade en el JS (si no está ya):
document.querySelectorAll('.acknowledge-btn').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const alertId = parseInt(this.dataset.alertId);
        acknowledgeAlert(alertId);
    });
});
</script>
</body>
</html>