{% extends "base.html" %}

{% block title %}{{ get_text('common.dashboard') }} - Lively Ageing{% endblock %}

{% block content %}
<div id="dashboard-root"></div>

<!-- Material-UI -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />

<!-- React and ReactDOM -->
<script src="https://unpkg.com/react@17/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>

<!-- Babel -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Material-UI -->
<script src="https://unpkg.com/@mui/material@5.0.0/umd/material-ui.development.js"></script>
<script src="https://unpkg.com/@mui/icons-material@5.0.0/index.js"></script>

<!-- Dashboard Component -->
<script type="text/babel" src="{{ url_for('static', filename='js/components/Dashboard.jsx') }}"></script>

<!-- Initialize Dashboard -->
<script type="text/babel">
    ReactDOM.render(
        <Dashboard />,
        document.getElementById('dashboard-root')
    );
</script>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });

    // Refresh button functionality
    const refreshBtn = document.getElementById('refreshBtn');
    const spinners = document.querySelectorAll('.spinner-border');
    
    refreshBtn.addEventListener('click', function() {
        // Show loading state
        refreshBtn.disabled = true;
        refreshBtn.querySelector('.spinner-border').classList.remove('d-none');
        spinners.forEach(spinner => spinner.classList.remove('d-none'));
        
        // Make an AJAX call to refresh the data
        fetch(window.location.href, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            // Replace the content of the dashboard
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newContent = doc.querySelector('.container');
            document.querySelector('.container').innerHTML = newContent.innerHTML;
            
            // Reinitialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            });
        })
        .catch(error => {
            console.error('Error refreshing data:', error);
            alert('Error refreshing data. Please try again.');
        })
        .finally(() => {
            // Reset button state
            refreshBtn.disabled = false;
            refreshBtn.querySelector('.spinner-border').classList.add('d-none');
            spinners.forEach(spinner => spinner.classList.add('d-none'));
        });
    });

    // Scroll to top button
    const scrollTopBtn = document.getElementById('scrollTopBtn');
    
    window.addEventListener('scroll', function() {
        if (window.pageYOffset > 100) {
            scrollTopBtn.classList.remove('d-none');
        } else {
            scrollTopBtn.classList.add('d-none');
        }
    });
    
    scrollTopBtn.addEventListener('click', function() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });
});
</script>
{% endblock %}